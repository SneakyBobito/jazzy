/*
 Copyright (c) 2013-2014 Soufiane Ghzal
 Code under MIT LICENSE

 Permission is hereby granted, free of charge, to any person obtaining a copy
 of this software and associated documentation files (the "Software"), to deal
 in the Software without restriction, including without limitation the rights
 to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 copies of the Software, and to permit persons to whom the Software is
 furnished to do so, subject to the following conditions:

 The above copyright notice and this permission notice shall be included in
 all copies or substantial portions of the Software.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 THE SOFTWARE.
*/
var Jazzy=function(M){(function(){function f(a,b){return[a[0]+b[0],a[1]+b[1]]}function l(a,b){return[a[0]-b[0],a[1]-b[1]]}function e(a,b){return"number"===typeof b?[a[0]*b,a[1]*b]:[a[0]*b[0],a[1]*b[1]]}function h(a){return a[0]+a[1]}function B(a,b,c){for(;0<c;c--)a+=b;return a}function m(a,b){b=b||{};this.duration={value:b.value||4,dots:b.dots||0};this.coord=a}function q(a){this.coord=a}function s(a,b){function c(a){for(var b=0,c=a.length;b<c;b++)m[b+1]=a[b];r=a.length}b=b||"";this.name=a.name().toUpperCase()+
a.accidental()+b;this.symbol=b;this.root=a;this.intervals=[];this._voicing=[];var g,f,e,l,h="quality",k=[],m="P1 M3 P5 m7 M9 P11 M13".split(" "),r=2,t;b=b.replace(/[,\s\(\)]/g,"");t=b.split("/");2===t.length?(b=t[0],t=t[1]):t=null;g=0;for(f=b.length;g<f&&(e=b[g]);g++){switch(h){case "quality":l=g+3<=f?b.substr(g,3).toLowerCase():null;l=l in C?l:e in C?e:"";c(C[l]);g+=l.length-1;h="extension";break;case "extension":e="1"===e&&b[g+1]?parseFloat(b.substr(g,2)):parseFloat(e);if(isNaN(e)||6===e)6===e?
(m[3]="M6",r=3>r?3:r):g-=1;else{r=(e-1)/2;if(r!==Math.round(r))throw Error("Invalid interval extension: "+e.toString(10));if("o"===l||"dim"===l)m[3]="d7";g+=String(e).length-1}h="alterations";break;case "alterations":e=b.substr(g).split(/(#|b|add|maj|sus|M)/i);var n,s=h=!1;if(1===e.length)throw Error("Invalid alterations");if(0!==e[0].length)throw Error("Invalid token: '"+e[0]+"'");for(var u=1,v=e.length;u<v;u++)switch(n=e[u+1],e[u]){case "M":case "Maj":case "maj":r=3>r?3:r;"7"===n&&u++;m[3]="M7";
break;case "Sus":case "sus":var p="P4";if("2"===n||"4"===n)u++,"2"===n&&(p="M2");m[1]=p;break;case "Add":case "add":n&&!isNaN(+n)&&("9"===n?k.push("M9"):"11"===n?k.push("P11"):"13"===n&&k.push("M13"),u+=n.length);break;case "b":h=!0;break;case "#":s=!0;break;default:if(0===e[u].length)break;n=+e[u];var q;if(isNaN(n)||String(n).length!==e[u].length)throw Error("Invalid token: '"+e[u]+"'");if(6===n){m[3]=s?"A6":h?"m6":"M6";r=3>r?3:r;continue}q=(n-1)/2;r<q&&(r=q);if(5>n||7===n||q!==Math.round(q))throw Error("Invalid interval alteration: "+
n);p=m[q][0];if(s)if("d"===p)p="m";else if("m"===p)p="M";else{if("M"===p||"P"===p)p="A"}else if(h)if("A"===p)p="M";else if("M"===p)p="m";else if("m"===p||"P"===p)p="d";s=h=!1;m[q]=p+n}h="ended"}if("ended"===h)break}t&&"9"===t&&(k.push("M9"),t=null);this.intervals=m.slice(0,r+1).concat(k).map(function(a){return d.interval(a)});g=0;for(f=this.intervals.length;g<f;g++)this._voicing[g]=this.intervals[g];if(t)for(k=this.intervals,t=d.note(t+(a.octave()+1)),g=d.interval.between(a,t),t=g.simple(),g=g.invert(),
g.direction("down"),this._voicing=[g],g=0;g<f;g++)k[g].simple().equal(t)||this._voicing.push(k[g])}function y(a,b){var c,g;if(!(a instanceof m))throw Error("Invalid Tonic");if("string"===typeof b){if(c=b,b=d.scale.scales[b],!b)throw Error("Invalid Scale");}else for(g in d.scale.scales)if(d.scale.scales.hasOwnProperty(g)&&d.scale.scales[g].toString()===b.toString()){c=g;break}this.name=c;this.tonic=a;this.scale=b}var d={},z={c:[0,0],d:[-1,2],e:[-2,4],f:[1,-1],g:[0,1],a:[-1,3],b:[-2,5],h:[-2,5]},w=
{unison:[0,0],second:[3,-5],third:[2,-3],fourth:[1,-1],fifth:[0,1],sixth:[3,-4],seventh:[2,-2],octave:[1,0]},D="second sixth third seventh fourth unison fifth".split(" "),E="unison second third fourth fifth sixth seventh octave ninth tenth eleventh twelfth thirteenth fourteenth fifteenth".split(" "),F="fcgdaeb".split(""),G=["bb","b","","#","x"],v=[-4,7],A=f(z.a,[4,0]),J={"0.25":"longa","0.5":"breve",1:"whole",2:"half",4:"quarter",8:"eighth",16:"sixteenth",32:"thirty-second",64:"sixty-fourth",128:"hundred-twenty-eighth"},
K={P:"perfect",M:"major",m:"minor",A:"augmented",AA:"doubly augmented",d:"diminished",dd:"doubly diminished"},H={perfect:["dd","d","P","A","AA"],minor:"dd d m M A AA".split(" ")},C={min:["m3","P5"],m:["m3","P5"],"-":["m3","P5"],M:["M3","P5"],"":["M3","P5"],"+":["M3","A5"],aug:["M3","A5"],dim:["m3","d5"],o:["m3","d5"],maj:["M3","P5","M7"],dom:["M3","P5","m7"],"\u00f8":["m3","d5","m7"],5:["P5"]},I={major:"M",minor:"m",augmented:"aug",diminished:"dim","half-diminished":"7b5",power:"5",dominant:"7"},
x={unison:1,first:1,second:2,third:3,fourth:4,fifth:5,sixth:6,seventh:7,octave:8,ninth:9,eleventh:11,thirteenth:13},L={dd1:"daw",d1:"de",P1:"do",A1:"di",AA1:"dai",d2:"raw",m2:"ra",M2:"re",A2:"ri",AA2:"rai",d3:"maw",m3:"me",M3:"mi",A3:"mai",dd4:"faw",d4:"fe",P4:"fa",A4:"fi",AA4:"fai",dd5:"saw",d5:"se",P5:"so",A5:"si",AA5:"sai",d6:"law",m6:"le",M6:"la",A6:"li",AA6:"lai",d7:"taw",m7:"te",M7:"ti",A7:"tai",dd8:"daw",d8:"de",P8:"do",A8:"di",AA8:"dai"};d.note=function(a,b){return"string"===typeof a?d.note.fromString(a,
b):new m(a,b)};d.note.fromKey=function(a){var b=Math.floor((a-4)/12),c=F[(2*Math.round((a-12*b-4)/2)+1)%7],b=f(l(z[c],A),[b+1,0]);a=a-49-h(e(b,[12,7]));return d.note(a?f(b,e(v,a)):b)};d.note.fromFrequency=function(a,b){var c,g;b=b||440;c=49+12*((Math.log(a)-Math.log(b))/Math.log(2));c=Math.round(c);g=b*Math.pow(2,(c-49)/12);g=1200*(Math.log(a/g)/Math.log(2));return{note:d.note.fromKey(c),cents:g}};d.note.fromMIDI=function(a){return d.note.fromKey(a-20)};d.note.fromString=function(a,b){var c=/^([a-h])(x|#|bb|b?)([,\']*)$/i,
g,d,h;if((g=a.match(/^([a-h])(x|#|bb|b?)(-?\d*)/i))&&a===g[0]&&g[3].length)d=g[1],c=+g[3];else{a=a.replace(/\u2032/g,"'").replace(/\u0375/g,",");g=a.match(c);if(!g||a!==g[0])throw Error("Invalid note format");d=g[1];c=g[3];h=d===d.toLowerCase();if(c.length)if(c.match(/^'+$/)&&h)c=3+c.length;else if(c.match(/^,+$/)&&!h)c=2-c.length;else throw Error("Format must respect the Helmholtz format");else c=h?3:2}g=g[2].length?g[2].toLowerCase():"";d=d.toLowerCase();d=[z[d][0],z[d][1]];d=f(d,[c,0]);d=f(d,e(v,
G.indexOf(g)-2));return new m(l(d,A),b)};d.chord=function(a,b){if("string"===typeof a){var c,g;if((c=a.match(/^([a-h])(x|#|bb|b?)/i))&&c[0])return g="number"===typeof b?b.toString(10):"4",new s(d.note(c[0].toLowerCase()+g),a.substr(c[0].length))}else if(a instanceof m)return new s(a,b);throw Error("Invalid Chord. Couldn't find note name");};d.interval=function(a,b){if("string"===typeof a)return d.interval.toCoord(a);if("string"===typeof b&&a instanceof m)return d.interval.from(a,d.interval.toCoord(b));
if(b instanceof q&&a instanceof m)return d.interval.from(a,b);if(b instanceof m&&a instanceof m)return d.interval.between(a,b);throw Error("Invalid parameters");};d.interval.toCoord=function(a){var b,c,g,d;b=a.match(/^(AA|A|P|M|m|d|dd)(-?\d+)$/);if(!b)throw Error("Invalid simple format interval");a=b[1];c=+b[2];c=(b=0>c)?-c:c;g=8<c?c%7?c%7:7:c;d=w[E[g-1]];c=f(d,[(c-g)/7,0]);d=1>=d[0]?"perfect":"minor";if("perfect"===d&&("M"===a||"m"===a)||"minor"===d&&"P"===a)throw Error("Invalid interval quality");
a=H[d].indexOf(a)-2;c=f(c,e(v,a));c=b?e(c,-1):c;return new q(c)};d.interval.from=function(a,b){return new m(f(a.coord,b.coord))};d.interval.between=function(a,b){return new q(l(b.coord,a.coord))};d.interval.invert=function(a){return d.interval(a).invert().toString()};d.scale=function(a,b){a instanceof m||(a=d.note(a));return new y(a,b)};d.scale.scales={};m.prototype={octave:function(){return this.coord[0]+A[0]-z[this.name()][0]+4*this.accidentalValue()},name:function(){return F[this.coord[1]+A[1]-
7*this.accidentalValue()+1]},accidentalValue:function(){return Math.round((this.coord[1]+A[1]-2)/7)},accidental:function(){return G[this.accidentalValue()+2]},key:function(a){return a?7*this.coord[0]+4*this.coord[1]+29:12*this.coord[0]+7*this.coord[1]+49},fq:function(a){return(a||440)*Math.pow(2,(12*this.coord[0]+7*this.coord[1])/12)},chroma:function(){var a=(h(e(this.coord,[12,7]))-3)%12;return 0>a?a+12:a},scale:function(a){return d.scale(this,a)},interval:function(a){return d.interval(this,a)},
transpose:function(a){this.coord=d.interval(this,a).coord;return this},chord:function(a){a=a in I?I[a]:a;return new s(this,a)},helmholtz:function(){var a=this.octave(),b=this.name(),b=3>a?b.toUpperCase():b.toLowerCase(),c=3>a?",":"'",a=2>a?2-a:a-3;return B(b+this.accidental(),c,a)},scientific:function(){return this.name().toUpperCase()+this.accidental()+this.octave()},enharmonics:function(a){var b=this.key(),c=a?2:3;return["m3","m2","m-2","m-3"].map(this.interval.bind(this)).filter(function(a){var d=
a.accidentalValue(),h=b-(a.key()-d);if(h<c&&h>-c)return a.coord=f(a.coord,e(v,h-d)),!0})},solfege:function(a,b){if(!(a instanceof y))throw Error("Invalid Scale");var c=a.tonic.interval(this),g,d;"down"===c.direction()&&(c=c.invert());b&&(d=(this.key(!0)-a.tonic.key(!0))/7,d=0<=d?Math.floor(d):-Math.ceil(-d),g=0<=d?"'":",");c=L[c.simple(!0).toString()];return b?B(c,g,Math.abs(d)):c},durationName:function(){return J[this.duration.value]},durationInSeconds:function(a,b){var c=60/a/(this.duration.value/
4)/(b/4);return 2*c-c/Math.pow(2,this.duration.dots)},scaleDegree:function(a){var b=a.tonic.interval(this);if("down"===b.direction()||0===b.coord[1]&&0!==b.coord[0])b=b.invert();b=b.simple(!0).coord;return a.scale.reduce(function(a,g,e){g=d.interval(g).coord;return g[0]===b[0]&&g[1]===b[1]?e+1:a},0)},toString:function(a){return this.name()+this.accidental()+(a?"":this.octave())}};q.prototype={name:function(){return E[this.number()-1]},semitones:function(){return h(e(this.coord,[12,7]))},number:function(){return Math.abs(this.value())},
value:function(){var a=l(this.coord,e(v,Math.floor((this.coord[1]-2)/7)+1)),b;b=D[a[1]+5];a=x[b]+7*(a[0]-w[b][0]);return 0<a?a:a-2},type:function(){return 1>=w[this.base()][0]?"perfect":"minor"},base:function(){var a=l(this.coord,e(v,this.qualityValue()))[1],a=0<this.value()?a+5:-(a-5)%7,a=0>a?D.length+a:a,a=D[a];"unison"===a&&8<=this.number()&&(a="octave");return a},direction:function(a){return a?((1<=this.value()?"up":"down")!==a&&(this.coord=e(this.coord,-1)),this):1<=this.value()?"up":"down"},
simple:function(a){var b=w[this.base()],b=f(b,e(v,this.qualityValue()));a||(b="down"===this.direction()?e(b,-1):b);return new q(b)},isCompound:function(){return 8<this.number()},octaves:function(){var a;"up"===this.direction()?(a=l(this.coord,e(v,this.qualityValue())),a=a[0]-w[this.base()][0]):(a=l(this.coord,e(v,-this.qualityValue())),a=-(a[0]+w[this.base()][0]));return a},invert:function(){var a=this.base(),b=this.qualityValue(),b="minor"===this.type()?-(b-1):-b,a=w[E[9-x[a]-1]],a=f(a,e(v,b));return new q(a)},
quality:function(a){var b=H[this.type()][this.qualityValue()+2];return a?K[b]:b},qualityValue:function(){return"down"===this.direction()?Math.floor((-this.coord[1]-2)/7)+1:Math.floor((this.coord[1]-2)/7)+1},equal:function(a){return this.coord[0]===a.coord[0]&&this.coord[1]===a.coord[1]},greater:function(a){var b=this.semitones(),c=a.semitones();return b===c?this.number()>a.number():b>c},smaller:function(a){return!this.equal(a)&&!this.greater(a)},add:function(a){return new q(f(this.coord,a.coord))},
toString:function(a){a=a?this.number():this.value();return this.quality()+a}};s.prototype={notes:function(){for(var a=this.voicing(),b=[],c=0,g=a.length;c<g;c++)b.push(d.interval.from(this.root,a[c]));return b},voicing:function(a){if(!a)return this._voicing;this._voicing=[];for(var b=0,c=a.length;b<c;b++)this._voicing[b]=d.interval(a[b]);return this},resetVoicing:function(){this._voicing=this.intervals},dominant:function(a){a=a||"";return new s(this.root.interval("P5"),a)},subdominant:function(a){a=
a||"";return new s(this.root.interval("P4"),a)},parallel:function(a){a=this.quality();if("triad"!==this.chordType()||"diminished"===a||"augmented"===a)throw Error("Only major/minor triads have parallel chords");return"major"===a?new s(this.root.interval("m3","down"),"m"):new s(this.root.interval("m3","up"))},quality:function(){for(var a,b,c,d=this.intervals,e=0,f=d.length;e<f;e++)3===d[e].number()?a=d[e]:5===d[e].number()?b=d[e]:7===d[e].number()&&(c=d[e]);if(a){a="down"===a.direction()?a.invert():
a;a=a.simple().toString();b&&(b="down"===b.direction?b.invert():b,b=b.simple().toString());c&&(c="down"===c.direction?c.invert():c,c=c.simple().toString());if("M3"===a)return"A5"===b?"augmented":"P5"===b?"m7"===c?"dominant":"major":"major";if("m3"===a)return"P5"!==b&&"d5"===b?"m7"===c?"half-diminished":"diminished":"minor"}},chordType:function(){var a=this.intervals.length,b,c,d,e,f;if(2===a)return"dyad";if(3===a){c={first:!1,third:!1,fifth:!1};for(e=0;e<a;e++)b=this.intervals[e],d=b.invert(),b.base()in
c?c[b.base()]=!0:d.base()in c&&(c[d.base()]=!0);f=c.first&&c.third&&c.fifth?"triad":"trichord"}else if(4===a){c={first:!1,third:!1,fifth:!1,seventh:!1};for(e=0;e<a;e++)b=this.intervals[e],d=b.invert(),b.base()in c?c[b.base()]=!0:d.base()in c&&(c[d.base()]=!0);c.first&&c.third&&c.fifth&&c.seventh&&(f="tetrad")}return f||"unknown"},get:function(a){if("string"===typeof a&&a in x){var b=this.intervals,c,e;a=x[a];c=0;for(e=b.length;c<e;c++)if(b[c].number()===a)return d.interval.from(this.root,b[c]);return null}throw Error("Invalid interval name");
},interval:function(a){return new s(this.root.interval(a),this.symbol)},transpose:function(a){this.root.transpose(a);this.name=this.root.name().toUpperCase()+this.root.accidental()+this.symbol;return this},toString:function(){return this.name}};y.prototype={notes:function(){for(var a=[],b=0,c=this.scale.length;b<c;b++)a.push(d.interval(this.tonic,this.scale[b]));return a},simple:function(){return this.notes().map(function(a){return a.toString(!0)})},type:function(){var a=this.scale.length-2;if(8>
a)return"di tri tetra penta hexa hepta octa".split(" ")[a]+"tonic"},get:function(a){a="string"===typeof a&&a in x?x[a]:a;return this.tonic.interval(this.scale[a-1])},solfege:function(a,b){return a?this.get(a).solfege(this,b):this.notes().map(function(a){return a.solfege(this,b)})},interval:function(a){return new y(this.tonic.interval(a),this.scale)},transpose:function(a){a=this.interval(a);this.scale=a.scale;this.tonic=a.tonic;return this}};d.scale.scales.ionian=d.scale.scales.major="P1 M2 M3 P4 P5 M6 M7".split(" ");
d.scale.scales.dorian="P1 M2 m3 P4 P5 M6 m7".split(" ");d.scale.scales.phrygian="P1 m2 m3 P4 P5 m6 m7".split(" ");d.scale.scales.lydian="P1 M2 M3 A4 P5 M6 M7".split(" ");d.scale.scales.mixolydian="P1 M2 M3 P4 P5 M6 m7".split(" ");d.scale.scales.aeolian=d.scale.scales.minor="P1 M2 m3 P4 P5 m6 m7".split(" ");d.scale.scales.locrian="P1 m2 m3 P4 d5 m6 m7".split(" ");d.scale.scales.majorpentatonic=["P1","M2","M3","P5","M6"];d.scale.scales.minorpentatonic=["P1","m3","P4","P5","m7"];d.scale.scales.chromatic=
d.scale.scales.harmonicchromatic="P1 m2 M2 m3 M3 P4 A4 P5 m6 M6 m7 M7".split(" ");d.TeoriaNote=m;d.TeoriaChord=s;d.TeoriaScale=y;d.TeoriaInterval=q;"undefined"!==typeof exports?("undefined"!==typeof module&&module.exports&&(exports=module.exports=d),exports.teoria=d):"undefined"!==typeof this?this.teoria=d:"undefined"!==typeof window&&(window.teoria=d)})();var h={applyParams:function(f,h,e){h=h||{};for(var k in e)f[k]=e[k]&&void 0!==e[k].kCallback?e[k].kCallback(h[k]):h[k]||e[k]},error:function(f,
h){var e="Jazzy Error : "+f;void 0!==h&&(e+=" More informations at : "+h);console.log(e)},debug:function(f){console.log(f)},Bindable:function(){}};h.Bindable.prototype={bind:function(f,h){this.bindable_bounds||(this.bindable_bounds={});this.bindable_bounds[f]||(this.bindable_bounds[f]=[]);this.bindable_bounds[f].push(h)},fire:function(f,h,e){e=void 0===e?!1:e;if(!this.bindable_bounds||!this.bindable_bounds[f])return!0;for(var k=0;k<this.bindable_bounds[f].length;k++){var B=this.bindable_bounds[f][k].apply(this,
h);if(e&&!1===B)return!1}return!0}};h.Bindable.extends=function(f){f.prototype.bind=h.Bindable.prototype.bind;f.prototype.fire=h.Bindable.prototype.fire};h.Exception=function(f){console.error(f)};h.Entity=function(){};h.EntityName={};h.Entity.prototype={export:function(){var f={},h;for(h in this.creator._iEntities){var e=this.creator._iEntities[h],e="function"===typeof e.export?e.export.call(this,this[e.name]):this[e.name];f[h]=e}return f},import:function(f){for(var h in this.creator._iEntities){var e=
this.creator._iEntities[h],k=null;f.hasOwnProperty(e.name)?k=f[e.name]:void 0!==e.default&&(k=e.default);this[e.name]="function"===typeof e.import?e.import.call(this,k,f):k}}};h.Entity.extends=function(f,l){f.prototype=Object.create(h.Entity.prototype);f._iEntities={};for(var e=0;e<l.length;e++){var k=h.Entity.__parseDataDef(l[e]);k.name||(h.error("Entity Data has no name"),h.debug(k));f._iEntities[k.name]=k}};h.Entity.registerName=function(f,l){h.EntityName[f]=l};h.createEntity=function(f,l){var e=
new h.EntityName[f];e.creator=h.EntityName[f];l&&e.import(l);return e};h.Entity.__parseDataDef=function(f){var l={},e;"string"===typeof f?e={name:f}:"object"===typeof f?e=f:(h.error("Bad data definition"),h.debug(f));h.applyParams(l,e,{name:void 0,import:null,export:null,default:void 0});return l};h.Entity.Chord=function(){};h.Entity.extends(h.Entity.Chord,{chord:{"export":function(f){return f.name()},"import":function(f,h){return new teoria.chord(f)}},root:{"export":function(f){return f.scientific()},
"import":function(f,h){return new teoria.note(f)}}});h.Entity.registerName("chord",h.Entity.Chord);return h}();
